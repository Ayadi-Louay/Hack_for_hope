# üéØ DOCKER COMPOSE - Orchestration de tous les services
# Ce fichier permet de lancer TOUT le projet avec une seule commande : docker-compose up

services:
  # üì¶ BASE DE DONN√âES PostgreSQL
  # Stocke : utilisateurs, incidents, d√©cisions, audit logs, pi√®ces jointes (m√©tadonn√©es)
  db:
    image: postgres:15-alpine  # Version l√©g√®re et rapide
    container_name: hackforhope_db
    restart: always
    environment:
      POSTGRES_USER: hackforhope
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: hackforhope_db
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - "5432:5432"  # Accessible depuis votre machine sur localhost:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persistance des donn√©es
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql  # Script d'initialisation automatique
    networks:
      - hackforhope_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hackforhope"]
      interval: 10s
      timeout: 5s
      retries: 5

  #  BACKEND (API NestJS)
  # G√®re : authentification, RBAC, CRUD incidents, upload fichiers, audit logs
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hackforhope_backend
    restart: always
    environment:
      NODE_ENV: development
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: hackforhope
      DB_PASSWORD: admin
      DB_NAME: hackforhope_db
      DATABASE_URL: postgresql://hackforhope:admin@db:5432/hackforhope_db
      JWT_SECRET: your_super_secret_jwt_key_change_in_production
      PORT: 3001
    ports:
      - "3001:3001"  # API accessible sur http://localhost:3001
    volumes:
      - ./backend:/app  # Hot reload pendant le d√©veloppement
      - /app/node_modules  # √âvite de monter node_modules de l'h√¥te
      - uploads_data:/app/uploads  # Stockage des pi√®ces jointes
    depends_on:
      db:
        condition: service_healthy  # Attend que PostgreSQL soit pr√™t
    networks:
      - hackforhope_network
    command: npm run start:dev  # Mode d√©veloppement avec hot reload

  # üé® FRONTEND (Next.js)
  # Interface utilisateur : pages login, dashboard, incidents, rapports
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: hackforhope_frontend
    restart: always
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001  # URL de l'API backend
      NODE_ENV: development
    ports:
      - "3000:3000"  # Application accessible sur http://localhost:3000
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next  # Cache Next.js
    depends_on:
      - backend  # Attend que le backend soit pr√™t
    networks:
      - hackforhope_network
    command: npm run dev

# üíæ VOLUMES PERSISTANTS
# Garde les donn√©es m√™me apr√®s arr√™t des conteneurs
volumes:
  postgres_data:  # Donn√©es PostgreSQL
  uploads_data:   # Fichiers upload√©s (photos, audio, vid√©os)

# üåê R√âSEAU INTERNE
# Permet la communication entre conteneurs
networks:
  hackforhope_network:
    driver: bridge
